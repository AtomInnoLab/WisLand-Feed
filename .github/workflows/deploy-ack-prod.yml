name: deploy_ali_ack-prod

on:
  pull_request_target:
    branches: [main]
    types: [closed]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

env:
  KUBECTL_VERSION: v1.32.2
  NAMESPACE: prod-ns
  REPO_NS: mxrag
  DEPLOYMENT: wisland-feed-prod

  REPO: ${{ secrets.ALI_DOCKER_REGISTRY }}
  REPO_USER: ${{ secrets.ALI_DOCKER_REGISTRY_USERNAME_PENGHAO }}
  REPO_PASSWD: ${{ secrets.ALI_DOCKER_REGISTRY_PASSWD_PENGHAO }}
  FEISHU_WEBHOOK_URL_PROD: ${{ secrets.FEISHU_WEBHOOK_URL_PROD }}
  KUBECONFIG_PROD: ${{ secrets.KUBECONFIG_PROD }}

jobs:
  build_and_push:
    # ä»…åœ¨ä»¥ä¸‹æƒ…å†µè¿è¡Œï¼š
    # 2. PR åˆå¹¶åˆ° prodï¼ˆgithub.event_name == 'pull_request_target' ä¸” merged == trueï¼‰
    # 3. æ‰‹åŠ¨è§¦å‘ï¼ˆgithub.event_name == 'workflow_dispatch'ï¼‰
    if: |
      github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request_target' && github.event.pull_request.merged == true)
    name: build_and_push
    permissions:
      contents: write
    runs-on: [ubuntu-22.04]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust-stable
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: 1.88.0
          override: true
      
      - name: Set proxy
        run: |
          rm -rf ~/.gitconfig || true
          git config --global url."https://${{ secrets.GH_ACCESS_TOKEN }}@github.com".insteadOf ssh://git@github.com
          git config --global credential.helper store

      - name: Building
        shell: bash
        run: cargo build -r

      - name: Generate Docker Tag
        id: docker_tag
        run: |
          datetime_now=$(TZ='Asia/Shanghai' date "+%Y%m%d%H%M%S")
          echo "DOCKER_TAG=${datetime_now}" >> $GITHUB_ENV
          echo "tag=${datetime_now}" >> $GITHUB_OUTPUT

      - name: Log in to Aliyun ACR
        run: |
          docker login \
            -u ${{ env.REPO_USER }} \
            -p ${{ env.REPO_PASSWD }} \
            ${{ env.REPO }}

      - name: Build and Push Docker Image
        run: |
          sudo apt-get update && sudo apt-get install -y retry
          docker build --build-arg APP_PROFILE=prod -f Dockerfile.server -t ${{ env.REPO }}/${{ env.REPO_NS }}/${{ env.DEPLOYMENT }}:server-${{ env.DOCKER_TAG }} .
          docker build --build-arg APP_PROFILE=prod -f Dockerfile.worker -t ${{ env.REPO }}/${{ env.REPO_NS }}/${{ env.DEPLOYMENT }}:worker-${{ env.DOCKER_TAG }} .
          retry -t 5 -- docker push ${{ env.REPO }}/${{ env.REPO_NS }}/${{ env.DEPLOYMENT }}:server-${{ env.DOCKER_TAG }}
          retry -t 5 -- docker push ${{ env.REPO }}/${{ env.REPO_NS }}/${{ env.DEPLOYMENT }}:worker-${{ env.DOCKER_TAG }}


      - name: Set DOCKER_TAG_SERVER and DOCKER_TAG_WORKER for next job
        run: |
          echo "Image built: ${{ env.REPO }}/${{ env.REPO_NS }}/${{ env.DEPLOYMENT }}:${{ env.DOCKER_TAG }}"
    outputs:
      docker_tag: ${{ steps.docker_tag.outputs.tag }}

  deploy_to_canary:
    needs: build_and_push
    name: deploy_to_canary
    permissions:
      contents: write
    runs-on: [ubuntu-22.04]
    steps:
      - uses: actions/checkout@v4

      - name: Setup kubectl
        uses: ./.github/actions/setup-kubectl-ack
        with:
          kubectl-version: ${{ env.KUBECTL_VERSION }}
          kubeconfig-env: ${{ env.KUBECONFIG_PROD }}

      - name: Apply canary
        shell: bash
        run: |
          IMAGE_SERVER="${{ env.REPO }}/${{ env.REPO_NS }}/${{ env.DEPLOYMENT }}:server-${{ needs.build_and_push.outputs.docker_tag }}"
          IMAGE_WORKER="${{ env.REPO }}/${{ env.REPO_NS }}/${{ env.DEPLOYMENT }}:worker-${{ needs.build_and_push.outputs.docker_tag }}"
          kubectl -n "${{ env.NAMESPACE }}" delete deployment ${{ env.DEPLOYMENT }}-canary --ignore-not-found=true
          kubectl -n "${{ env.NAMESPACE }}" set image \
            -f k8s/canary/deployment-canary.yml \
            ${{ env.DEPLOYMENT }}-canary-server="$IMAGE_SERVER" \
            ${{ env.DEPLOYMENT }}-canary-worker="$IMAGE_WORKER" \
            --local -o yaml \
          | kubectl -n "${{ env.NAMESPACE }}" apply -f -
          kubectl -n "${{ env.NAMESPACE }}" apply  -f k8s/canary/service-canary.yml
          kubectl -n "${{ env.NAMESPACE }}" apply  -f k8s/canary/ingress-canary.yaml
          kubectl -n "${{ env.NAMESPACE }}" rollout status "deployment/${{ env.DEPLOYMENT }}-canary" --timeout=180s

      - name: Notify Feishu - canary
        uses: ./.github/actions/send-feishu
        with:
          webhook: ${{ env.FEISHU_WEBHOOK_URL_PROD }}
          status-emoji: "ğŸŸ¡"
          title: "ACK: ${{ env.DEPLOYMENT }}-canary deployed"
          details: "ä»“åº“: ${{ github.repository }}%0Aåˆ†æ”¯: ${{ github.ref_name }}%0Aæäº¤: ${{ github.sha }}%0Aé•œåƒ: ${{ needs.build_and_push.outputs.docker_tag }}%0Aæµ‹è¯•: header ä¸­æ·»åŠ  X-Canary: grey%0AURL: https://wisland-feed-canary.atominnolab.com"

  manual_approval:
    needs: [build_and_push, deploy_to_canary]
    name: manual_approval
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Wait for Manual Approval
        id: approve_full_release
        uses: trstringer/manual-approval@v1
        with:
          issue-title: "ğŸš¦ ç°åº¦éªŒè¯å®Œæˆï¼Œæ˜¯å¦å…¨é‡å‘å¸ƒï¼Ÿ"
          issue-body: |
            ç°åº¦å·²å®Œæˆï¼Œè¯·é€‰æ‹©æ˜¯å¦å…¨é‡å‘å¸ƒæ–°ç‰ˆæœ¬ã€‚
            é•œåƒ: ${{ env.REPO }}/${{ env.REPO_NS }}/${{ env.DEPLOYMENT }}:${{ needs.build_and_push.outputs.docker_tag }}
            - Approveï¼ˆåŒæ„ï¼‰ï¼šå…¨é‡å‘å¸ƒï¼ˆè¯„è®ºï¼šapprove or yesï¼‰
            - Denyï¼ˆæ‹’ç»ï¼‰ï¼šè‡ªåŠ¨å›æ»šï¼ˆè¯„è®ºï¼šdeny or noï¼‰
          secret: ${{ github.TOKEN }}
          minimum-approvals: 1
          approvers: pengzuhao,yingyuankai,yuezh000
          additional-approved-words: 'approve,yes'
          additional-denied-words: 'deny,no'
          fail-on-denial: false                           # å®¡æ‰¹æ‹’ç»æ—¶ç»§ç»­æ‰§è¡Œ
          exclude-workflow-initiator-as-approver: false   # å‘èµ·äººä¹Ÿå¯ä»¥å®¡æ‰¹
          # timeout-minutes: 10

      - name: Debug approval output
        run: |
          echo "approved value: '${{ steps.approve_full_release.outputs.approved }}'"
          echo "approval-status: '${{ steps.approve_full_release.outputs.approval-status }}'"
          echo "Type: ${{ steps.approve_full_release.outcome }}"
    outputs:
      approval_status: ${{ steps.approve_full_release.outputs.approval-status }}

  release:
    needs: [build_and_push, deploy_to_canary, manual_approval]
    name: release_new
    if: ${{ needs.manual_approval.outputs.approval_status == 'approved' }}
    permissions:
      contents: read
    runs-on: [ubuntu-22.04]
    steps:
      - uses: actions/checkout@v4

      - name: Setup kubectl
        uses: ./.github/actions/setup-kubectl-ack
        with:
          kubectl-version: ${{ env.KUBECTL_VERSION }}
          kubeconfig-env: ${{ env.KUBECONFIG_PROD }}

      - name: Update
        run: |
          kubectl -n "${{ env.NAMESPACE }}" \
            set image deployment/${{ env.DEPLOYMENT }} \
            ${{ env.DEPLOYMENT }}-server=${{ env.REPO }}/${{ env.REPO_NS }}/${{ env.DEPLOYMENT }}:server-${{ needs.build_and_push.outputs.docker_tag }} \
            ${{ env.DEPLOYMENT }}-worker=${{ env.REPO }}/${{ env.REPO_NS }}/${{ env.DEPLOYMENT }}:worker-${{ needs.build_and_push.outputs.docker_tag }}
          kubectl -n "${{ env.NAMESPACE }}" delete -f k8s/canary/ingress-canary.yaml
          kubectl -n "${{ env.NAMESPACE }}" delete -f k8s/canary/service-canary.yml
          kubectl -n "${{ env.NAMESPACE }}" delete deployment ${{ env.DEPLOYMENT }}-canary

      - name: Notify Feishu - update
        uses: ./.github/actions/send-feishu
        with:
          webhook: ${{ env.FEISHU_WEBHOOK_URL_PROD }}
          status-emoji: "ğŸŸ¢"
          title: "ACK: ${{ env.DEPLOYMENT }} released"
          details: "ä»“åº“: ${{ github.repository }}%0Aåˆ†æ”¯: ${{ github.ref_name }}%0Aæäº¤: ${{ github.sha }}%0Aé•œåƒ: ${{ needs.build_and_push.outputs.docker_tag }}"

  rollback:
    needs: [build_and_push, deploy_to_canary, manual_approval]
    name: roll_back
    if: ${{ needs.manual_approval.outputs.approval_status == 'denied' }}
    permissions:
      contents: read
    runs-on: [ubuntu-22.04]
    steps:
      - uses: actions/checkout@v4

      - name: Setup kubectl
        uses: ./.github/actions/setup-kubectl-ack
        with:
          kubectl-version: ${{ env.KUBECTL_VERSION }}
          kubeconfig-env: ${{ env.KUBECONFIG_PROD }}

      - name: Rollback
        run: |
          kubectl -n "${{ env.NAMESPACE }}" delete -f k8s/canary/ingress-canary.yaml
          kubectl -n "${{ env.NAMESPACE }}" delete -f k8s/canary/service-canary.yml
          kubectl -n "${{ env.NAMESPACE }}" delete deployment ${{ env.DEPLOYMENT }}-canary

      - name: Notify Feishu - rollback
        uses: ./.github/actions/send-feishu
        with:
          webhook: ${{ env.FEISHU_WEBHOOK_URL_PROD }}
          status-emoji: "ğŸ”´"
          title: "ACK: ${{ env.DEPLOYMENT }} rollbacked"
          details: "ä»“åº“: ${{ github.repository }}%0Aåˆ†æ”¯: ${{ github.ref_name }}%0Aæäº¤: ${{ github.sha }}%0Aé•œåƒ: ${{ needs.build_and_push.outputs.docker_tag }}"

  notify_failed_job:
    name: notify_failed_job
    needs: [build_and_push, deploy_to_canary, manual_approval]
    if: always() && (needs.build_and_push.result == 'failure' || needs.deploy_to_canary.result == 'failure' || needs.manual_approval.result == 'failure')
    runs-on: [ubuntu-22.04]
    steps:
      - uses: actions/checkout@v4
      
      - name: Notify Feishu - failed
        uses: ./.github/actions/send-feishu
        with:
          webhook: ${{ env.FEISHU_WEBHOOK_URL_PROD }}
          status-emoji: "ğŸ”´"
          title: "ACK: ${{ env.DEPLOYMENT }} deployment failed"
          details: "ä»“åº“: ${{ github.repository }}%0Aåˆ†æ”¯: ${{ github.ref_name }}%0Aæäº¤: ${{ github.sha }}"